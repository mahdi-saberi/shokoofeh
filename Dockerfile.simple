# Dockerfile ساده برای Laravel + Nginx
# این Dockerfile یک image واحد تولید می‌کند که هم nginx و هم PHP-FPM را دارد

FROM php:8.2-fpm-alpine

# نصب nginx و اکستنشن‌های PHP مورد نیاز
RUN apk add --no-cache \
    nginx \
    php82-gd \
    php82-intl \
    php82-mysqli \
    php82-pdo \
    php82-pdo_mysql \
    php82-zip \
    php82-fileinfo \
    php82-curl \
    php82-mbstring \
    php82-openssl \
    php82-tokenizer \
    php82-xml \
    php82-dom \
    php82-xmlreader \
    php82-xmlwriter \
    php82-simplexml \
    php82-ctype \
    php82-iconv \
    php82-opcache \
    php82-zlib \
    php82-session \
    php82-phar \
    && rm -rf /var/cache/apk/*

# نصب Composer
COPY --from=composer:2.5 /usr/bin/composer /usr/bin/composer

WORKDIR /var/www

# کپی کردن فایل‌های پروژه
COPY ./src /var/www

# ایجاد کاربر و گروه
RUN addgroup -g 1000 www \
    && adduser -u 1000 -G www -s /bin/sh -D www

# ایجاد دایرکتوری‌های Laravel
RUN mkdir -p /var/www/storage/framework/cache \
    && mkdir -p /var/www/storage/framework/sessions \
    && mkdir -p /var/www/storage/framework/views \
    && mkdir -p /var/www/storage/framework/testing \
    && mkdir -p /var/www/storage/logs \
    && mkdir -p /var/www/bootstrap/cache

# تنظیم مجوزها
RUN chown -R www:www /var/www \
    && chmod -R 775 /var/www/storage \
    && chmod -R 775 /var/www/bootstrap/cache \
    && chmod -R 775 /var/www/storage/framework \
    && chmod -R 775 /var/www/storage/logs

# نصب dependencies
RUN composer install --no-dev --optimize-autoloader --no-interaction

# تنظیم مجدد مجوزها بعد از composer install
RUN chown -R www:www /var/www \
    && chmod -R 775 /var/www/storage \
    && chmod -R 775 /var/www/bootstrap/cache

# کپی کردن nginx configuration
COPY nginx-unified.conf /etc/nginx/nginx.conf

# کپی کردن startup script
COPY start-services.sh /start-services.sh
RUN chmod +x /start-services.sh

# ایجاد دایرکتوری‌های مورد نیاز
RUN mkdir -p /var/log/nginx \
    && mkdir -p /var/lib/nginx \
    && mkdir -p /run/nginx \
    && mkdir -p /var/log/php-fpm

# بررسی نصب PHP-FPM
RUN echo "🔍 بررسی PHP-FPM..." \
    && php-fpm -v \
    && echo "✅ PHP-FPM نصب شد"

# Expose port
EXPOSE 80

# Start both services
CMD ["/start-services.sh"] 