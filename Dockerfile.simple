# Dockerfile Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Laravel + Nginx
# Ø§ÛŒÙ† Dockerfile ÛŒÚ© image ÙˆØ§Ø­Ø¯ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ù‡Ù… nginx Ùˆ Ù‡Ù… PHP-FPM Ø±Ø§ Ø¯Ø§Ø±Ø¯

FROM php:8.2-fpm-alpine

# Ù†ØµØ¨ nginx Ùˆ Ø§Ú©Ø³ØªÙ†Ø´Ù†â€ŒÙ‡Ø§ÛŒ PHP Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
RUN apk add --no-cache \
    nginx \
    php82-gd \
    php82-intl \
    php82-mysqli \
    php82-pdo \
    php82-pdo_mysql \
    php82-zip \
    php82-fileinfo \
    php82-curl \
    php82-mbstring \
    php82-openssl \
    php82-tokenizer \
    php82-xml \
    php82-dom \
    php82-xmlreader \
    php82-xmlwriter \
    php82-simplexml \
    php82-ctype \
    php82-iconv \
    php82-opcache \
    php82-zlib \
    php82-session \
    php82-phar \
    && rm -rf /var/cache/apk/*

# Ù†ØµØ¨ Composer
COPY --from=composer:2.5 /usr/bin/composer /usr/bin/composer

WORKDIR /var/www

# Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡
COPY ./src /var/www

# Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ú¯Ø±ÙˆÙ‡
RUN addgroup -g 1000 www \
    && adduser -u 1000 -G www -s /bin/sh -D www

# Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Laravel
RUN mkdir -p /var/www/storage/framework/cache \
    && mkdir -p /var/www/storage/framework/sessions \
    && mkdir -p /var/www/storage/framework/views \
    && mkdir -p /var/www/storage/framework/testing \
    && mkdir -p /var/www/storage/logs \
    && mkdir -p /var/www/bootstrap/cache

# ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§
RUN chown -R www:www /var/www \
    && chmod -R 775 /var/www/storage \
    && chmod -R 775 /var/www/bootstrap/cache \
    && chmod -R 775 /var/www/storage/framework \
    && chmod -R 775 /var/www/storage/logs

# Ù†ØµØ¨ dependencies
RUN composer install --no-dev --optimize-autoloader --no-interaction

# ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬Ø¯Ø¯ Ù…Ø¬ÙˆØ²Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ø² composer install
RUN chown -R www:www /var/www \
    && chmod -R 775 /var/www/storage \
    && chmod -R 775 /var/www/bootstrap/cache

# Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† nginx configuration
COPY nginx-unified.conf /etc/nginx/nginx.conf

# Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† startup script
COPY start-services.sh /start-services.sh
RUN chmod +x /start-services.sh

# Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
RUN mkdir -p /var/log/nginx \
    && mkdir -p /var/lib/nginx \
    && mkdir -p /run/nginx \
    && mkdir -p /var/log/php-fpm

# Ø¨Ø±Ø±Ø³ÛŒ Ù†ØµØ¨ PHP-FPM
RUN echo "ğŸ” Ø¨Ø±Ø±Ø³ÛŒ PHP-FPM..." \
    && php-fpm -v \
    && echo "âœ… PHP-FPM Ù†ØµØ¨ Ø´Ø¯"

# Expose port
EXPOSE 80

# Start both services
CMD ["/start-services.sh"] 